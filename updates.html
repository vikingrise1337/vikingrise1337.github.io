<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">

    <title>Viking Rise Update Notes</title>

    <meta name="theme-color" content="#d4af37">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="favicon.png">

    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"/>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&family=Roboto:wght@300;400;500&family=Ruslan+Display&display=swap');

        @font-face {
            font-family: 'CinzelRus';
            src: url('CinzelRus.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0b101b;
            color: #e2e8f0;
        }

        .viking-font { font-family: 'Cinzel', serif; }
        :lang(ru) .viking-font {
            font-family: 'CinzelRus', 'Times New Roman', serif;
            letter-spacing: 0.05em;
        }

        .gold-text { color: #d4af37; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Listen Styles */
        ul.detail-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        ul.detail-list li {
            position: relative;
            padding-left: 24px;
            margin-bottom: 8px;
            color: #cbd5e1;
        }

        ul.detail-list li::before {
            content: "•";
            position: absolute;
            left: 8px;
            top: 0;
            color: #64748b;
            font-weight: bold;
        }

        /* Dropdown Styles */
        details {
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        details[open] {
            border-color: #d4af37;
            background: rgba(0,0,0,0.3);
        }

        details > summary {
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.02);
            list-style: none; /* Firefox */
        }

        /* Default Marker ausblenden (Chrome/Safari/Firefox) */
        details > summary::-webkit-details-marker { display: none; }
        details > summary::marker { content: ""; }

        details > summary:hover { background: rgba(255,255,255,0.05); }

        .dropdown-content { padding: 15px; border-top: 1px solid rgba(255,255,255,0.05); }

        /* Pfeil-Rotation ohne Tailwind-Variant */
        .dropdown-arrow {
            transition: transform 0.2s ease;
        }
        details[open] .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* Sprach Buttons */
        .lang-btn { cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: color 0.3s; }
        .lang-active { color: #d4af37; text-decoration: underline; text-underline-offset: 4px; }
        .lang-inactive { color: #64748b; }
        .lang-inactive:hover { color: white; }
    </style>
</head>
<body class="min-h-screen pb-20">

<nav class="w-full z-50 border-b border-white/10 bg-[#0b101b]">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <a href="index.html" id="nav-home-link" class="flex items-center gap-2 hover:opacity-80 transition">
            <span class="material-symbols-outlined text-gray-400 notranslate">arrow_back</span>
            <span class="viking-font text-lg font-bold text-white"><span id="txt-back">Back to</span>
                <span class="text-[#d4af37]" id="txt-home">Home</span></span>
        </a>
        <div class="flex items-center gap-4">
            <div class="hidden sm:flex items-center mr-4 pr-4 border-r border-white/20">
                <span id="nav-clock" class="text-sm font-mono text-[#d4af37] font-bold">--:--:--</span>
            </div>
            <div class="flex gap-3">
                <a href="?lang=en" class="lang-btn" id="lang-en">EN</a> |
                <a href="?lang=de" class="lang-btn" id="lang-de">DE</a> |
                <a href="?lang=cn" class="lang-btn" id="lang-cn">CN</a> |
                <a href="?lang=ru" class="lang-btn" id="lang-ru">RU</a>
            </div>
        </div>
    </div>
</nav>

<div class="relative w-full h-80 md:h-96 overflow-hidden border-b-4 border-[#d4af37] mb-12">
    <img src="header-bg.jpg" id="hero-img"
         class="absolute inset-0 w-full h-full object-cover opacity-80 transition-opacity duration-500">
    <div class="absolute inset-0 bg-gradient-to-t from-[#0b101b] to-transparent"></div>

    <div class="absolute bottom-0 left-0 p-6 md:p-12 w-full">
        <span id="txt-badge"
              class="inline-block px-3 py-1 mb-2 text-xs font-bold text-black bg-[#d4af37] rounded uppercase">Update Archive</span>
        <h1 id="txt-title" class="text-4xl md:text-6xl font-bold text-white drop-shadow-lg mb-4 viking-font">Patch Notes</h1>

        <div class="relative inline-block w-full md:w-auto">
            <select id="version-select" onchange="changeVersion(this.value)"
                    class="appearance-none bg-black/60 border border-[#d4af37] text-white py-3 px-6 pr-12 rounded text-lg focus:outline-none cursor-pointer w-full md:w-auto backdrop-blur-sm">
                <option>Loading...</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#d4af37]">
                <span class="material-symbols-outlined notranslate">expand_more</span>
            </div>
        </div>
    </div>
</div>

<div class="container mx-auto px-4 -mt-10 relative z-10">

    <div class="glass-panel rounded-xl p-6 mb-8 border border-gray-700 flex flex-col md:flex-row items-center justify-between gap-4 shadow-xl">
        <div class="flex items-center gap-4">
            <span class="material-symbols-outlined text-4xl gold-text notranslate">update</span>
            <div>
                <h2 class="text-lg font-bold text-white"><span id="txt-utc">Release (UTC)</span></h2>
                <p id="utc-time-display" class="text-sm text-gray-400">--</p>
            </div>
        </div>
        <div id="maintenance-timer" class="text-center md:text-right bg-black/30 p-3 rounded-lg border border-gray-700">
            <p class="text-xs text-gray-400 uppercase tracking-widest mb-1" id="txt-local">Start Time (Local)</p>
            <p id="local-time-display" class="text-xl font-mono text-[#d4af37] font-bold">--</p>
        </div>
    </div>

    <div id="filter-buttons" class="flex gap-2 bg-[#1e293b] p-1 rounded-lg border border-gray-700 w-fit mb-6">
        <button id="btn-all" onclick="filterContent('all')"
                class="px-4 py-2 rounded-md text-sm font-bold bg-[#d4af37] text-black">All</button>
        <button id="btn-major" onclick="filterContent('major')"
                class="px-4 py-2 rounded-md text-sm font-bold text-gray-400">Highlights</button>
        <button id="btn-opt" onclick="filterContent('opt')"
                class="px-4 py-2 rounded-md text-sm font-bold text-gray-400">Details</button>
    </div>

    <div id="main-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <div id="major-updates-section" class="lg:col-span-2 space-y-8"></div>

        <div id="details-section" class="lg:col-span-1 space-y-6">

            <div class="glass-panel p-5 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold text-[#d4af37] mb-4 flex items-center gap-2 viking-font">
                    <span class="material-symbols-outlined notranslate">radio_button_unchecked</span>
                    <span id="txt-cat-new">New</span>
                </h3>
                <ul class="detail-list" id="list-new"></ul>
            </div>

            <div class="glass-panel p-5 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold text-blue-400 mb-4 flex items-center gap-2 viking-font">
                    <span class="material-symbols-outlined notranslate">tune</span>
                    <span id="txt-cat-opt">Optimizations</span>
                </h3>
                <div id="opt-container" class="space-y-2"></div>
            </div>

            <div class="glass-panel p-5 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold text-green-400 mb-4 flex items-center gap-2 viking-font">
                    <span class="material-symbols-outlined notranslate">pest_control</span>
                    <span id="txt-cat-fix">Fixes</span>
                </h3>
                <ul class="detail-list" id="list-fixes"></ul>
            </div>

        </div>
    </div>

    <div class="text-center mt-12 mb-4 text-gray-600 text-xs">Unofficial Patch Notes Page</div>
</div>

<script>
    const uiTranslations = {
        en: { back: "Back to", home: "Home", badge: "Update Archive", title: "Patch Notes", utc: "Release (UTC)", local: "Your Time", all: "All", major: "Highlights", opt: "Details", cat_new: "New Features", cat_opt: "Optimizations", cat_fix: "Fixes" },
        de: { back: "Zurück", home: "Start", badge: "Update Archiv", title: "Patch Notes", utc: "Release (UTC)", local: "Deine Zeit", all: "Alle", major: "Highlights", opt: "Details", cat_new: "Neuheiten", cat_opt: "Optimierungen", cat_fix: "Fehlerbehebung" },
        cn: { back: "返回", home: "主页", badge: "更新存档", title: "更新说明", utc: "发布 (UTC)", local: "当地时间", all: "全部", major: "亮点", opt: "详情", cat_new: "新功能", cat_opt: "优化", cat_fix: "修复" },
        ru: { back: "Назад", home: "Главная", badge: "Архив обновлений", title: "Патчноуты", utc: "Релиз (UTC)", local: "Ваше время", all: "Все", major: "Главное", opt: "Детали", cat_new: "Новое", cat_opt: "Оптимизация", cat_fix: "Исправления" }
    };

    const urlParams = new URLSearchParams(window.location.search);
    let currentLang = urlParams.get('lang');
    const validLangs = ['en', 'de', 'cn', 'ru'];
    if (!validLangs.includes(currentLang)) currentLang = 'en';

    let allPatchData = [];

    function startLiveClock() {
        setInterval(() => {
            const loc = currentLang === 'cn' ? 'zh-CN' : currentLang;
            document.getElementById('nav-clock').innerText = new Date().toLocaleTimeString(loc);
        }, 1000);
    }

    function updateUI() {
        const t = uiTranslations[currentLang];
        document.getElementById('txt-back').innerText = t.back;
        document.getElementById('txt-home').innerText = t.home;
        document.getElementById('txt-badge').innerText = t.badge;
        document.getElementById('txt-title').innerText = t.title;
        document.getElementById('txt-utc').innerText = t.utc;
        document.getElementById('txt-local').innerText = t.local;

        document.getElementById('btn-all').innerText = t.all;
        document.getElementById('btn-major').innerText = t.major;
        document.getElementById('btn-opt').innerText = t.opt;

        document.getElementById('txt-cat-new').innerText = t.cat_new;
        document.getElementById('txt-cat-opt').innerText = t.cat_opt;
        document.getElementById('txt-cat-fix').innerText = t.cat_fix;

        document.documentElement.lang = currentLang;
        document.getElementById('nav-home-link').href = `index.html?lang=${currentLang}`;

        validLangs.forEach(l => {
            const btn = document.getElementById(`lang-${l}`);
            btn.className = l === currentLang ? "lang-btn lang-active" : "lang-btn lang-inactive";
        });
    }

    function normalizeList(value) {
        if (!value) return [];
        if (Array.isArray(value)) return value.filter(Boolean).map(v => String(v).trim()).filter(Boolean);

        if (typeof value === "string") {
            return value
                .split(/\r?\n|•|\u2022/g)
                .map(s => s.trim())
                .filter(Boolean);
        }

        return [];
    }

    function parseTimestamp(ts) {
        if (ts === null || ts === undefined) return null;

        let n = ts;
        if (typeof n === "string") {
            const trimmed = n.trim();
            if (!trimmed) return null;
            if (!Number.isNaN(Number(trimmed))) n = Number(trimmed);
            else return new Date(trimmed);
        }

        if (typeof n === "number" && Number.isFinite(n)) {
            if (n < 1e12) n = n * 1000; // seconds -> ms
            return new Date(n);
        }

        if (ts instanceof Date) return ts;
        return null;
    }

    function setHeroImage(meta, update) {
        const heroImg = document.getElementById('hero-img');

        const candidates = [
            meta?.image_url,
            meta?.image,
            update?.image_url,
            update?.image
        ].filter(v => typeof v === "string" && v.trim() !== "");

        heroImg.src = candidates.length ? candidates[0] : "header-bg.jpg";
    }

    async function init() {
        startLiveClock();
        updateUI();

        try {
            const response = await fetch('patchnotes.json?v=' + new Date().getTime());
            const rawData = await response.json();

            allPatchData = (Array.isArray(rawData) ? rawData : []).filter(entry => entry?.type !== 'news');

            const sel = document.getElementById('version-select');
            sel.innerHTML = '';

            if (allPatchData.length === 0) {
                const opt = document.createElement('option');
                opt.text = "No Updates found";
                sel.appendChild(opt);
                return;
            }

            allPatchData.forEach((update, index) => {
                const opt = document.createElement('option');
                opt.value = String(index);
                const meta = update?.meta || {};
                const title = meta[`title_${currentLang}`] || meta.title_en || meta.title || "Update";
                opt.text = title;
                sel.appendChild(opt);
            });

            loadUpdate(0);
            filterContent('all');
        } catch (e) {
            console.error("Fehler beim Laden:", e);
        }
    }

    function changeVersion(index) {
        loadUpdate(Number(index));
        filterContent('all');
    }

    function fillList(id, items) {
        const el = document.getElementById(id);
        if (!el) return;
        const arr = normalizeList(items);
        el.innerHTML = arr.map(i => `<li>${i}</li>`).join('');
    }

    function loadUpdate(index) {
        const update = allPatchData[index];
        if (!update) return;

        const meta = update.meta || {};
        const data = update[currentLang] || update['en'] || {};
        const content = data.data || data;

        setHeroImage(meta, update);

        fillList('list-new', content.new_features || content.new || content.features);
        fillList('list-fixes', content.fixes || content.fix || content.bugfixes);

        const majorContainer = document.getElementById('major-updates-section');
        majorContainer.innerHTML = '';

        const majorItems = normalizeList(content.major || content.highlights);
        majorItems.forEach((txt, i) => {
            majorContainer.innerHTML += `
            <div class="glass-panel rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-2 viking-font">Highlight #${i + 1}</h3>
                <p class="text-gray-300 leading-relaxed">${txt}</p>
            </div>`;
        });

        const optContainer = document.getElementById('opt-container');
        optContainer.innerHTML = '';

        const optimizations = content.optimizations || content.optimization || [];
        if (Array.isArray(optimizations) && optimizations.length) {
            const first = optimizations[0];

            if (typeof first === "string") {
                const items = normalizeList(optimizations);
                renderOptimizationGroup(optContainer, uiTranslations[currentLang].cat_opt, items);
            } else {
                optimizations.forEach(opt => {
                    const title = opt?.title;
                    const items = normalizeList(opt?.items);
                    if (title && items.length) renderOptimizationGroup(optContainer, title, items);
                });
            }
        }

        document.getElementById('utc-time-display').innerText = meta.display_time || "--";

        const dt = parseTimestamp(meta.start_timestamp);
        if (dt) {
            const loc = currentLang === 'cn' ? 'zh-CN' : currentLang;
            const localStr = dt.toLocaleString(loc, { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            const offset = -(dt.getTimezoneOffset() / 60);
            const offsetStr = offset >= 0 ? `+${offset}` : String(offset);

            document.getElementById('local-time-display').innerHTML =
                `${localStr} <span class="text-sm font-normal text-gray-500">(UTC${offsetStr})</span>`;
        } else {
            document.getElementById('local-time-display').innerText = "--";
        }
    }

    function renderOptimizationGroup(container, title, items) {
        const details = document.createElement('details');

        const summary = document.createElement('summary');
        summary.innerHTML = `
            <span>${title}</span>
            <span class="material-symbols-outlined notranslate text-sm dropdown-arrow">expand_more</span>
        `;

        const contentDiv = document.createElement('div');
        contentDiv.className = "dropdown-content text-sm text-gray-300 pl-4";
        contentDiv.innerHTML = `<ul class="detail-list">${items.map(i => `<li>${i}</li>`).join('')}</ul>`;

        details.appendChild(summary);
        details.appendChild(contentDiv);
        container.appendChild(details);
    }

    function filterContent(type) {
        const btns = ['all', 'major', 'opt'];
        const leftCol = document.getElementById('major-updates-section');
        const rightCol = document.getElementById('details-section');
        const mainGrid = document.getElementById('main-grid');

        btns.forEach(btn => {
            const el = document.getElementById(`btn-${btn}`);
            if (!el) return;

            if (btn === type) {
                el.classList.remove('text-gray-400', 'hover:text-white');
                el.classList.add('bg-[#d4af37]', 'text-black');
            } else {
                el.classList.add('text-gray-400', 'hover:text-white');
                el.classList.remove('bg-[#d4af37]', 'text-black');
            }
        });

        if (type === 'all') {
            leftCol.style.display = 'block';
            rightCol.style.display = 'block';

            mainGrid.classList.add('grid-cols-1', 'lg:grid-cols-3');
            leftCol.className = 'lg:col-span-2 space-y-8';
            rightCol.className = 'lg:col-span-1 space-y-6';
        } else if (type === 'major') {
            leftCol.style.display = 'block';
            rightCol.style.display = 'none';

            mainGrid.classList.add('grid-cols-1');
            mainGrid.classList.remove('lg:grid-cols-3');
            leftCol.className = 'space-y-8 mx-auto max-w-4xl';
        } else if (type === 'opt') {
            leftCol.style.display = 'none';
            rightCol.style.display = 'block';

            mainGrid.classList.add('grid-cols-1');
            mainGrid.classList.remove('lg:grid-cols-3');
            rightCol.className = 'space-y-6 mx-auto max-w-3xl';
        }
    }

    init();
</script>
</body>
</html>
